#!/usr/bin/env modbuild

module use Libraries

INSTANTCLIENT_INCLUDE_DIR='/usr/include/oracle/12.1/client64'
INSTANTCLIENT_LIBRARY_DIR='/usr/lib/oracle/12.1/client64/lib'

declare -a EXTRA_LIBS=()
EXTRA_LIBS+=( "${INSTANTCLIENT_LIBRARY_DIR}/libclntshcore.so" )
EXTRA_LIBS+=( "${INSTANTCLIENT_LIBRARY_DIR}/libclntshcore.so.12.1" )
EXTRA_LIBS+=( "${INSTANTCLIENT_LIBRARY_DIR}/libclntsh.so" )
EXTRA_LIBS+=( "${INSTANTCLIENT_LIBRARY_DIR}/libclntsh.so.12.1" )
EXTRA_LIBS+=( "${INSTANTCLIENT_LIBRARY_DIR}/libipc1.so" )
EXTRA_LIBS+=( "${INSTANTCLIENT_LIBRARY_DIR}/libmql1.so" )
EXTRA_LIBS+=( "${INSTANTCLIENT_LIBRARY_DIR}/libnnz12.so" )
EXTRA_LIBS+=( "${INSTANTCLIENT_LIBRARY_DIR}/libocci.so" )
EXTRA_LIBS+=( "${INSTANTCLIENT_LIBRARY_DIR}/libocci.so.12.1" )
EXTRA_LIBS+=( "${INSTANTCLIENT_LIBRARY_DIR}/libociei.so" )
EXTRA_LIBS+=( "${INSTANTCLIENT_LIBRARY_DIR}/libocijdbc12.so" )
EXTRA_LIBS+=( "${INSTANTCLIENT_LIBRARY_DIR}/libons.so" )
EXTRA_LIBS+=( "${INSTANTCLIENT_LIBRARY_DIR}/liboramysql12.so" )


case ${OS} in
Darwin )
	# cocoa doesn't work with GCC!?
	#config_args='--enable-cocoa --disable-x11'
	config_args='--with-finkdir=/opt/X11 --disable-cocoa'
	;;
*)
	;;
esac

# enabled by default
# 	fftw3
#	oracle
#	xml
#
pbuild::configure() {
	"${MODULE_SRCDIR}"/configure \
		--enable-asimage \
		--enable-mathmore \
		--disable-ldap \
		--disable-mysql \
		--disable-opengl \
		--disable-python \
		--with-cc=${CC} \
		--with-cxx=${CXX} \
		--with-f77=${F77} \
		--with-ld=${CXX} \
		--with-oracle-incdir=${INSTANTCLIENT_INCLUDE_DIR} \
		--with-oracle-libdir=${INSTANTCLIENT_LIBRARY_DIR} \
		${config_args} \
		|| exit 1
}

pbuild::build() {
	make -j 4
}

pbuild::install() {
	make clean

	mkdir -p "${PREFIX}"
	cp -rv * "${PREFIX}"
	mkdir -p "${DOCDIR}"
	rsync --archive --verbose	 "${PREFIX}/LICENSE"	"${DOCDIR}/LICENSE"
	rsync --archive --verbose	 "${PREFIX}/man/"	"${PREFIX}/share/man/"
	rsync --archive --verbose	 "${PREFIX}/README/"	"${DOCDIR}/README/" 

	rm -rf	 "${PREFIX}/LICENSE"
	rm -rf	 "${PREFIX}/man/"
	rm -rf	 "${PREFIX}/README"

	rm -f  Makefile
	rm -rf config.*
	rm -rf core
	rm -rf io
	rm -rf math
	rm -rf net
	rm -rf hist
	rm -rf tree
	rm -rf graf2d
	rm -rf graf3d
	rm -rf gui
	rm -rf html
	rm -rf montecarlo
	rm -rf geom
	rm -rf proof
	rm -rf sql
	rm -rf misc
	rm -rf test
	rm -rf tmva
	rm -rf tutorials
	rm -rf rootx
}

pbuild::post_install() {
	for lib in "${EXTRA_LIBS[@]}"; do
		cp -av "${lib}" "${PREFIX}"/lib
	done
}

module use unstable
pbuild::add_to_group 'Compiler'
pbuild::set_runtime_dependencies "${COMPILER}"
pbuild::set_build_dependencies "${COMPILER}"
pbuild::make_all
