#!/usr/bin/env modbuild

# get mappings for our version numbers to the published tarfile names
TARNAME=$(grep -E "^${V_MAJOR}.${V_MINOR}" files/version-to-tarname.txt| awk '{print $2}')

# pbuild::set_download_url "https://gitlab.psi.ch/caubet_m/merlin-software/raw/master/$P/$P-${V_PKG}.tar.gz"
# pbuild::set_download_url "https://github.com/lammps/lammps/archive/${TARNAME}"
pbuild::set_download_url "https://lammps.sandia.gov/tars/${TARNAME}"

pbuild::add_to_group 'MPI'

pbuild::install_docfiles README LICENSE

pbuild::pre_configure() {
  pbuild::add_configure_args "-D CMAKE_BUILD_TYPE=RELEASE"

  pbuild::add_configure_args "-D BUILD_MPI=yes"
  pbuild::add_configure_args "-D BUILD_OMP=yes"
  pbuild::add_configure_args "-D BUILD_TOOLS=yes"
  pbuild::add_configure_args "-D BUILD_DOC=yes"

  pbuild::add_configure_args "-D LAMMPS_MACHINE=mpi"
  pbuild::add_configure_args "-D PKG_USER-OMP=yes"
  pbuild::add_configure_args "-D PKG_ASPHERE=yes"
  pbuild::add_configure_args "-D PKG_BODY=yes"
  pbuild::add_configure_args "-D PKG_COMPRESS=yes"
  pbuild::add_configure_args "-D PKG_CORESHELL=yes"
  pbuild::add_configure_args "-D PKG_DIPOLE=yes"
  pbuild::add_configure_args "-D PKG_GRANULAR=yes"
  pbuild::add_configure_args "-D PKG_MANYBODY=yes"
  pbuild::add_configure_args "-D PKG_KSPACE=yes"
  pbuild::add_configure_args "-D PKG_MC=yes"
  pbuild::add_configure_args "-D PKG_MISC=yes"
  pbuild::add_configure_args "-D PKG_MOLECULE=yes"
  pbuild::add_configure_args "-D PKG_MPIIO=yes"
  pbuild::add_configure_args "-D PKG_OPT=yes"
  pbuild::add_configure_args "-D PKG_PYTHON=yes"
  pbuild::add_configure_args "-D PKG_REPLICA=yes"
  pbuild::add_configure_args "-D PKG_RIGID=yes"
  pbuild::add_configure_args "-D PKG_SNAP=yes"
  pbuild::add_configure_args "-D PKG_USER-EFF=yes"
  pbuild::add_configure_args "-D PKG_USER-DRUDE=yes"
  pbuild::add_configure_args "-D PKG_USER-REAXC=yes"
  # (( ${OPENMPI_VERSION%%.*}  >= 4 )) && pbuild::add_configure_args "-D LAMMPS_OMP_COMPAT=4"
}

pbuild::configure() {
	cmake ${BUILD_DIR}/../src/cmake -D CMAKE_INSTALL_PREFIX="${PREFIX}"
}

pbuild::compile() {
	cmake --build ${BUILD_DIR}
}

pbuild::install() {
        make install
}
