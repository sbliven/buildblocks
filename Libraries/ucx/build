#!/usr/bin/env modbuild

pbuild::set_download_url "https://github.com/openucx/ucx/releases/download/v${V_PKG}/$P-${V_PKG}.tar.gz"
pbuild::add_to_group 'Libraries'

# use system gcc to compile
declare -rx CC=gcc
declare -rx CPP=/usr/bin/cpp

pbuild::pre_configure() {
  # pbuild::add_configure_args "--disable-shared"
  pbuild::add_configure_args "--with-pic"

  pbuild::add_configure_args "--enable-optimizations" # Recommended when compiled from source
  pbuild::add_configure_args "--disable-logging"
  pbuild::add_configure_args "--disable-debug"
  pbuild::add_configure_args "--disable-assertions"
  pbuild::add_configure_args "--disable-params-check"
  pbuild::add_configure_args "--without-cm"
  pbuild::add_configure_args "--without-rocm"
  pbuild::add_configure_args "--without-xpmem"
  pbuild::add_configure_args "--without-ugni"
  pbuild::add_configure_args "--without-java"
  pbuild::add_configure_args "--enable-cma"
  pbuild::add_configure_args "--enable-mt"
  pbuild::add_configure_args "--with-verbs"

  if [[ -n "${CUDA_VERSION}" ]]; then
    pbuild::add_configure_args "--with-cuda=${CUDA_HOME}"
  fi

  if [[ -n "${KNEM_VERSION}" ]]; then
    pbuild::add_configure_args "--with-knem"
  fi

  if [[ -n "${GDRCOPY_VERSION}" ]]; then
    pbuild::add_configure_args "--with-gdrcopy"
  else
    pbuild::add_configure_args "--without-gdrcopy"
  fi

  if pbuild::use_flag slurm || pbuild::use_flag dgx; then
    pbuild::add_configure_args "--with-rdmacm"
  fi
}
