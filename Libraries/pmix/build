#!/usr/bin/env modbuild

echo "https://github.com/openpmix/openpmix/releases/download/v${V_PKG}/$P-${V_PKG}.tar.gz"
pbuild::set_download_url "https://github.com/openpmix/openpmix/releases/download/v${V_PKG}/$P-${V_PKG}.tar.gz"

pbuild::add_to_group 'Libraries'

(( version = (${V_MAJOR} * 100 + ${V_MINOR}) * 100 + V_PATCHLVL ))
if (( V_MAJOR > 1 )); then
  pbuild::install_docfiles AUTHORS README.md LICENSE NEWS VERSION
else 
  pbuild::install_docfiles README LICENSE NEWS VERSION
fi

pbuild::compile_in_sourcetree

pbuild::pre_configure() {
  if [[ -n "${HWLOC_PREFIX}" ]]; then
    pbuild::add_configure_args "--with-hwloc=${HWLOC_PREFIX}"
  fi

  if [[ -n "${LIBEVENT_PREFIX}" ]]; then
    pbuild::add_configure_args "--with-libevent=${LIBEVENT_PREFIX}"
  fi

  if [[ -n "${INTEL_VERSION}" ]]; then
          pbuild::add_configure_args "CC=icc"
          pbuild::add_configure_args "CXX=icpc"
          pbuild::add_configure_args "FC=ifort"
          pbuild::add_configure_args "F77=ifort"
          pbuild::add_configure_args "F90=ifort"
          # pbuild::add_configure_args "LDFLAGS=-Wc,-static-intel"
  fi

  # pbuild::add_configure_args "--enable-pmi-backward-compatibility"
  pbuild::add_configure_args "--enable-shared"
  pbuild::add_configure_args "--enable-static"
}
