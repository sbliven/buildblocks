#!/usr/bin/env modbuild

pbuild::pre_configure() {
   echo "> Setting performance system compiler flags"
   case "$(uname -m)" in
       aarch64)
           export CC=gcc
           export CXX=g++
           export CFLAGS='-march=native -O3 -pipe -Wno-error'
           export CXXFLAGS='-march=native -O3 -pipe -Wno-error'
           export FFLAGS='-march=native -O3 -pipe'
           export FCFLAGS='-march=native -O3 -pipe'
           export LDFLAGS='-Wl,--as-needed'
           ;;
       x86_64)
           export CC=gcc
           export CXX=g++
           export CFLAGS='-march=znver2 -mtune=znver2 -O3 -pipe -Wno-error'
           export CXXFLAGS='-march=znver2 -mtune=znver2 -O3 -pipe -Wno-error'
           export FFLAGS='-march=znver2 -mtune=znver2 -O3 -pipe'
           export FCFLAGS='-march=znver2 -mtune=znver2 -O3 -pipe'
           export LDFLAGS='-Wl,--as-needed'
           ;;
       *)
           echo ">> Unknown system architecture $(uname -m). Using default flags."
           export CC=gcc
           export CXX=g++
           export CFLAGS='-O3 -pipe -Wno-error'
           export CXXFLAGS='-O3 -pipe -Wno-error'
           export FFLAGS='-O3 -pipe'
           export FCFLAGS='-O3 -pipe'
           export LDFLAGS='-Wl,--as-needed'
           ;;
   esac
}

pbuild::configure() {
    cmake \
        -DCMAKE_INSTALL_PREFIX="${PREFIX}" \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_C_COMPILER="${MPICC}" \
        -DCMAKE_CXX_COMPILER="${MPICXX}" \
        -DCMAKE_C_FLAGS="${CFLAGS}" \
        -DCMAKE_CXX_FLAGS="${CXXFLAGS}" \
        -DCMAKE_Fortran_FLAGS="${FFLAGS}" \
        -DCMAKE_EXE_LINKER_FLAGS="${LDFLAGS}" \
        -DCMAKE_SHARED_LINKER_FLAGS="${LDFLAGS}" \
        "${SRC_DIR}/cmake"
}
