#!/usr/bin/env modbuild

PERFORMANCE="yes"
PROFILE="no"
SP="no"

pbuild::prep() {

    local BRANCH
    if [[ "$V" =~ beta$ ]]; then
        BRANCH="ver${V_MAJOR}.${V_MINOR}"
    elif [[ "$V" =~ profile$ ]]; then
        BRANCH="${V_PKG}"
        PROFILE="yes"
    elif [[ "$V" =~ sp$ ]]; then
        BRANCH="ver${V_MAJOR}.${V_MINOR}"
        SP="yes"
    else
        BRANCH="${V_PKG}"
    fi

    # Load modules for aarch64 builds for version 5.0.0-perf
    if [[ "$(uname -m)" == "aarch64" && "$V" == "5.0.0-perf" ]]; then
        module switch cuda/12.8.1
    fi

    # Clone or update source repository
    if [[ -d "$SRC_DIR/.git" ]]; then
        cd "$SRC_DIR" || return $?
        git pull || return $?
    else
        git clone --depth=1 -b "$BRANCH" https://github.com/3dem/relion.git "$SRC_DIR" || return $?
    fi
}

pbuild::pre_configure() {

    # Profile-specific configure arguments
    if [[ "$PROFILE" == "yes" && "$V_MAJOR" -lt 5 ]]; then
        : pbuild::add_configure_args "-DCMAKE_BUILD_TYPE=BENCHMARKING"
    fi

    # Single-precision specific configure arguments
    if [[ "$SP" == "yes" && "$V_MAJOR" -lt 5 ]]; then
        : pbuild::add_configure_args "-DDoublePrec_CPU=OFF"
    fi

    # Performance-oriented compiler flags
    if [[ "$PERFORMANCE" == "yes" && "$PROFILE" == "no" ]]; then
        echo "> Setting performance system compiler flags"
        case "$(uname -m)" in
            aarch64)
                export CC=gcc
                export CXX=g++
                export CFLAGS='-march=native -O3 -pipe -Wno-error'
                export CXXFLAGS='-march=native -O3 -pipe -Wno-error'
                export FFLAGS='-march=native -O3 -pipe'
                export FCFLAGS='-march=native -O3 -pipe'
                export LDFLAGS='-Wl,--as-needed'
                ;;
            x86_64)
                export CC=gcc
                export CXX=g++
                export CFLAGS='-march=znver2 -mtune=znver2 -O3 -pipe -Wno-error'
                export CXXFLAGS='-march=znver2 -mtune=znver2 -O3 -pipe -Wno-error'
                export FFLAGS='-march=znver2 -mtune=znver2 -O3 -pipe'
                export FCFLAGS='-march=znver2 -mtune=znver2 -O3 -pipe'
                export LDFLAGS='-Wl,--as-needed'
                ;;
            *)
                echo ">> Unknown system architecture $(uname -m). Using default flags."
                export CC=gcc
                export CXX=g++
                export CFLAGS='-O3 -pipe -Wno-error'
                export CXXFLAGS='-O3 -pipe -Wno-error'
                export FFLAGS='-O3 -pipe'
                export FCFLAGS='-O3 -pipe'
                export LDFLAGS='-Wl,--as-needed'
                ;;
        esac
        echo ">> ${CC} ${CFLAGS}"
        echo ">> ${CXX} ${CXXFLAGS}"
    fi

    # Additional setup for versions >= 4
    if [[ "$V_MAJOR" -ge 4 ]]; then
        # Blush weights
        echo "> Downloading blush weights"
        mkdir -p "$PREFIX/torch/hub/checkpoints/relion_blush"
        wget -q https://zenodo.org/records/10072731/files/blush_v1.0.ckpt.gz -P "$PREFIX/torch/hub/checkpoints/relion_blush" \
            && gunzip -f "$PREFIX/torch/hub/checkpoints/relion_blush/blush_v1.0.ckpt.gz" \
            && mv -f "$PREFIX/torch/hub/checkpoints/relion_blush/blush_v1.0.ckpt" "$PREFIX/torch/hub/checkpoints/relion_blush/v1.0.ckpt" \
            && touch "$PREFIX/torch/hub/checkpoints/relion_blush/v1.0_installed.txt"

        # Classranker
        echo "> Downloading classranker"
        mkdir -p "$PREFIX/torch/hub/checkpoints/relion_class_ranker"
        wget -q ftp://ftp.mrc-lmb.cam.ac.uk/pub/dari/classranker_v1.0.ckpt.gz -P "$PREFIX/torch/hub/checkpoints/relion_class_ranker" \
            && gunzip -f "$PREFIX/torch/hub/checkpoints/relion_class_ranker/classranker_v1.0.ckpt.gz" \
            && mv -f "$PREFIX/torch/hub/checkpoints/relion_class_ranker/classranker_v1.0.ckpt" "$PREFIX/torch/hub/checkpoints/relion_class_ranker/v1.0.ckpt" \
            && touch "$PREFIX/torch/hub/checkpoints/relion_class_ranker/v1.0_installed.txt"

        # FLTK
        echo "> Downloading FLTK"
        mkdir -p "$SRC_DIR/external/fltk"
        wget -q https://github.com/fltk/fltk/releases/download/release-1.4.4/fltk-1.4.4-source.tar.gz -P "$SRC_DIR/external/fltk/"

        # Miniforge installation
        echo "> Installing Miniforge"
        mkdir -p "$PREFIX/miniforge"
        wget -q "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-$(uname)-$(uname -m).sh" -O "$PREFIX/miniforge/miniforge.sh"
        bash "$PREFIX/miniforge/miniforge.sh" -b -u -p "$PREFIX/miniforge/"

        # Conda environment setup (only for specific versions)
        pushd "$SRC_DIR" || return $?
        if [[ "$(uname -m)" == "aarch64" ]]; then
            echo "> Checking version for GH200 (aarch64) Conda setup"
            if [[ "$V" == "5.0.0-perf" || "$V" == "5.0.1" ]]; then
                if [[ "$V" == "5.0.0-perf" ]]; then
                    cp "$BUILDBLOCK_DIR/environment_gh200_5.0.0-perf.yml" .
                    "$PREFIX/miniforge/condabin/conda" env create -q -f environment_gh200_5.0.0-perf.yml
                else
                    cp "$BUILDBLOCK_DIR/environment_gh200_5.0.1.yml" .
                    "$PREFIX/miniforge/condabin/conda" env create -q -f environment_gh200_5.0.1.yml
                fi
                "$PREFIX/miniforge/condabin/conda" env list

                echo "> Cloning model-angelo"
                git clone https://github.com/3dem/model-angelo "$SRC_DIR/model-angelo"
                pushd "$SRC_DIR/model-angelo" || return $?
                echo "> Fixing pyhmmer version in setup.py"
                sed -i 's/pyhmmer==[0-9\.]\+/pyhmmer==0.11.1/' setup.py
                echo "> Installing model-angelo"
                "$PREFIX/miniforge/condabin/conda" run -n "${P}-${V_MAJOR}.${V_MINOR}" python -m pip install .
                popd || return $?
            else
                echo "> Skipping Conda environment setup for version $V"
            fi
        else
            echo "> Checking version for x86_64 Conda setup"
            if [[ "$V" == "5.0.0-perf" || "$V" == "5.0.1" ]]; then
                if [[ "$V" == "5.0.0-perf" ]]; then
                    cp "$BUILDBLOCK_DIR/environment_5.0.0-perf.yml" .
                    "$PREFIX/miniforge/condabin/conda" env create -q -f environment_5.0.0-perf.yml
                else
                    cp "$BUILDBLOCK_DIR/environment_5.0.1.yml" .
                    "$PREFIX/miniforge/condabin/conda" env create -q -f environment_5.0.1.yml
                fi
                "$PREFIX/miniforge/condabin/conda" env list
            else
                echo "> Skipping Conda environment setup for version $V"
            fi
        fi
        popd || return $?
    fi
}
