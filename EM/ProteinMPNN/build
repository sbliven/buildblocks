#!/usr/bin/env modbuild

pbuild::configure() {
    # Install Miniforge
    mkdir -p "$PREFIX/miniforge"
    wget -q "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-$(uname)-$(uname -m).sh" -O "$PREFIX/miniforge/miniforge.sh"
    bash "$PREFIX/miniforge/miniforge.sh" -b -u -p "$PREFIX/miniforge"

    # Initialize conda for script use
    source "$PREFIX/miniforge/etc/profile.d/conda.sh"

    # Create the conda environment
    conda env create -y --name "${P}_${V_PKG}" -f "$BUILDBLOCK_DIR/environment.yml"
}

pbuild::compile() {
    :
}

pbuild::install() {
    # Ensure target directory exists
    mkdir -p "$PREFIX/bin"

    # Define destination
    DEST_DIR="$PREFIX/bin"

    # Create the destination directory if it doesn't exist
    mkdir -p "$DEST_DIR"

    # Function to copy .py files, add shebang, and make executable
    process_py_files() {
      for filepath in "$1"/*.py; do
        [ -e "$filepath" ] || continue  # skip if no .py files
        filename=$(basename "$filepath")
        dest="$DEST_DIR/$filename"

        # Add shebang and copy
        {
          echo '#!/usr/bin/env python'
          cat "$filepath"
        } > "$dest"

        chmod a+x "$dest"
      done
    }

    # Copy main scripts and helper_scripts
    process_py_files "$SRC_DIR"
    process_py_files "$SRC_DIR/helper_scripts"
}
